<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>유니talk</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!--/* 구글폰트(Quicksand, Dongle, Gowun Dodum, Noto Sans Korean) */-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dongle:wght@300&family=Gowun+Dodum&family=Quicksand:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.1.0/uicons-regular-rounded/css/uicons-regular-rounded.css">
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.1.0/uicons-solid-rounded/css/uicons-solid-rounded.css">
    <link rel="shortcut icon" href="/public/image/commons/logo_fill.png">
    <script src="/public/js/lockLikeMobile.js"></script>

    <script src="/public/js/meetingFooter.js"></script>
    <link rel="stylesheet" href="/public/css/meetingFooterCSS.css">

    <style>
    *{
        /* font-family: 'Dongle', sans-serif; */
        /* font-family: 'Gowun Dodum', sans-serif; */
        /* font-family: 'Quicksand', sans-serif; */
        /* font-family: 'Noto Sans KR', sans-serif; */
        font-family: 'Pretendard Variable', Pretendard, Roboto;        
    }    

    .userChatImageBox{
        width: 3em;
        height: 3em; 
        border-radius: 40%;
        overflow: hidden;
    }

    .userImage{
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .shadowBox{        
        border: 1px solid black;        
        box-shadow: 0.5em 0.5em 0.5em rgba(0, 0, 0, 0.1);
    }

    /* #chatRoomOffCanvas {
        position: fixed;
        top: 0;
        right: -100%;
        width: 100%;
        height: 100%;        
        transition: right 0.3s ease-in-out;
        z-index: 10;
    }

    #chatRoomOffCanvas.show {
        right: 0;
    } */


    </style>
</head>

<script th:inline="javascript">
let sessionUserInfo = /*[[${session.sessionUserInfo}]]*/;
let sessionUserProfileInfo = /*[[${session.meetingProfileInfo}]]*/;

console.log('sessionUserProfileInfo: ', sessionUserProfileInfo);
console.log('sessionUserInfo: ', sessionUserInfo);



/* function showChatRoomOffCanvas(chatRoomID){
    // const chatRoomOffCanvas = document.getElementById("chatRoomOffCanvas");
    // chatRoomOffCanvas.classList.add("show");

    const myOffcanvas = bootstrap.Offcanvas.getOrCreateInstance('#myOffcanvas')
    console.log('myOffcanvas: ', myOffcanvas);
    myOffcanvas.show();
}

function closeChatRoomOffCanvas(){
    const myOffcanvas = bootstrap.Offcanvas.getOrCreateInstance('#myOffcanvas')
    console.log('myOffcanvas: ', myOffcanvas);
    myOffcanvas.hide();
}
*/

function moveChatRoom(chatRoomId){
    console.log('chatRoomId: ', chatRoomId);
    window.location.href = "./chatRoomPage?chatRoomId=" + chatRoomId;
}

function getUserChatRoomData(){
    const userProfileId = sessionUserProfileInfo.profileid;    
    return fetch("./api/getUserChatRoomData?profileId=" + userProfileId)
    .then(response => response.json())
    .then(response => {
        const chatRoomData = response.data;
        return chatRoomData;
    });
}

function chatListCSR(){

    const chatListWrapperCol = document.getElementById("chatListWrapperCol");
    chatListWrapperCol.innerHTML = "";

    getUserChatRoomData()
    .then(chatRoomData => {
        console.log('chatRoomData: ', chatRoomData);
        if(chatRoomData.length > 0){
            for(e of chatRoomData){
                const chatListRow = document.querySelector("#templete #chatListRow").cloneNode(true);
                chatListRow.setAttribute("chatRoomId", e.chatRoomDto.chatRoomId);
        
                const chatRoomImage = chatListRow.querySelector("#chatRoomImage");
                chatRoomImage.setAttribute("src", `/uploadFiles/ufuf/meeting/profileImage/${e.targetProfileDto.profileImg}`);
        
                const chatRoomTitle = chatListRow.querySelector("#chatRoomTitle");
                chatRoomTitle.innerText = e.targetProfileDto.profileNickname;

                const chatRoomMessageLength = e.chatMessageList.length;
                if(chatRoomMessageLength === 0){
                    const chatRoomLastMessage = chatListRow.querySelector("#chatRoomLastMessage");
                    chatRoomLastMessage.innerText = '대화내용이 없습니다.';
                    const lastMesaggeTime = chatListRow.querySelector("#lastMesaggeTime");
                    lastMesaggeTime.innerText = "";
                }
                else{
                    const chatRoomLastMessage = chatListRow.querySelector("#chatRoomLastMessage");
                    chatRoomLastMessage.innerText = e.chatMessageList[chatRoomMessageLength-1].chatComment;
                    const lastMesaggeTime = chatListRow.querySelector("#lastMesaggeTime");
                    const lastMesaggeTimeValue = e.chatMessageList[chatRoomMessageLength-1].regdate;
                    const dateOption = {                    
                        month : 'long',
                        day : 'numeric',                    
                    };
                    const convertDate = dateConverter(lastMesaggeTimeValue, dateOption);
                    lastMesaggeTime.innerText = convertDate;
                }                
                chatListWrapperCol.appendChild(chatListRow);
            }
        }
        else{
            const notExistChatRoom = document.querySelector("#templete #notExistChatRoom").cloneNode(true);
            chatListWrapperCol.classList.remove("bg-white");
            chatListWrapperCol.appendChild(notExistChatRoom);
        }        
    });    
}

function dateConverter(dateTimedata, option){
    const array = new Date(dateTimedata[0], dateTimedata[1] - 1 , dateTimedata[2]);
    const convertDate = Intl.DateTimeFormat('ko-KR', option).format(array);
    return convertDate;
}

document.addEventListener("DOMContentLoaded", ()=>{
    chatListCSR();
    
});

</script>

<body>
    <div class="container-fluid pt-5 pb-5" style="background-color: #f5ededea;">
        
        <!--/* 임시 탑 에어리어 */-->
        <div class="row fixed-top bg-white" style="height: 3.3em;">
            <div class="col align-self-center">
                <div class="row mt-1 mx-1 justify-content-between">
                    <div class="col ps-0">
                        <div class="row">
                            <div class="col-auto" onclick="window.location.href='./mainPage'">
                                <img src="/public/image/meeting/ufuf_image_icon.png" class="img-fluid" style="width: 2em; height: auto;">
                            </div>
                            <div class="col-auto align-self-center px-0">
                                <span class="">Uni Signal</span>
                            </div>                            
                        </div>
                    </div>
                    <div class="col-auto align-self-center">
                        <span class="fs-5 text-secondary"><i class="fi fi-rr-bell bi-align-middle"></i></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                
                <div class="row mt-4 mb-2">
                    <div class="col">
                        
                        <div class="row">
                            <div class="col">
                                <span class="fs-4 fw-bold">시그널톡</span>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="row mt-3">
                    <div id="chatListWrapperCol" class="col mx-2 bg-white border border-0 rounded">

                    </div>
                </div>
            </div>
        </div>

        <th:block th:replace="~{meeting/meetingFooterFragment.html :: footer}"></th:block>
        
    </div>


<!--/* templete */-->
<div id="templete" class="d-none">
    
    <div id="chatListRow" class="row my-3 justify-content-between" onclick="moveChatRoom(this.getAttribute('chatroomid'))">
        <div class="col">
            <div class="row">
                <div class="col-auto">
                    <div class="row">
                        <div class="col-auto">
                            <div class="userChatImageBox">
                                <img id="chatRoomImage" class="img-fluid userImage">
                            </div>                                            
                        </div>
                    </div>
                </div>
                <div class="col-auto align-self-center ps-0">
                    <div class="row justify-content-between">
                        <div class="col-auto">
                            <span id="chatRoomTitle" class="fw-bold"></span>
                        </div>                                            
                    </div>
                    <div class="row">
                        <div class="col-12 text-truncate">
                            <span id="chatRoomLastMessage" class="" style="font-size: 0.9em;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-auto">
            <div class="row">
                <div class="col-auto">
                    <span id="lastMesaggeTime" class="text-secondary" style="font-size: 0.7em;"></span>
                </div>
            </div>
        </div>        
    </div>

    <div id="notExistChatRoom" class="row">
        <div class="col">
            <div class="row">
                <div class="col text-center">
                    <span class="fw-bold text-secondary text-opacity-50" style="font-size: 8em;"><i class="fi fi-rr-comment-dots bi-align-middle"></i></span>
                </div>
            </div>
            <div class="row">
                <div class="col text-center">
                    <span class="fw-bold text-secondary text-opacity-50">아직 개설된 채팅이 없어요.</span>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col text-center">
                    <span class="fw-bold text-secondary text-opacity-50">마음에 드는 상대에게 시그널을 보내보세요!</span>
                </div>
            </div>
        </div>
    </div>

</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>

</html>