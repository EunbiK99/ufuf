<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>미션진행</title>
        
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.1.0/uicons-thin-straight/css/uicons-thin-straight.css'>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7319aff03174c9825e5552818af66d19&libraries=services"></script>
    
<script>

    var relativePath = window.location.origin;
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);

    const chat_room_id = urlParams.get('chat_room_id');
    const mission_id = urlParams.get('mission_id');

    var nowMarker;
    var goalMarker;
    var map;
    var missionMarker = [];

    var imageSrc = relativePath + "/public/image/mission/free-icon-flag-5216262.png", // 마커이미지의 주소입니다    
    imageSize = new kakao.maps.Size(36, 36), // 마커이미지의 크기입니다
    imageOption = {offset: new kakao.maps.Point(24, 30)};

    var goalImg = relativePath + "/public/image/mission/free-icon-goal-5230487.png", // 마커이미지의 주소입니다    
    goalImgSize = new kakao.maps.Size(36, 36), // 마커이미지의 크기입니다
    goalImgOption = {offset: new kakao.maps.Point(24, 30)};

    var personImg = relativePath + "/public/image/mission/free-icon-person-8226827.png",
    personImgSize = new kakao.maps.Size(42, 41),
    personImgOption = {offset: new kakao.maps.Point(24, 20)};

    var sessionUser = "[[${session.sessionUserInfo.user_id}]]";

    // 지금 현재 위치 가져오기
    function getNowLocation(callback){

    if (navigator.geolocation) {

        function getLocation() {
            navigator.geolocation.getCurrentPosition(function (position) {
                
                var lat = position.coords.latitude; // 위도
                var lon = position.coords.longitude; // 경도

                var locPosition = new kakao.maps.LatLng(lat, lon);

                if (nowMarker) {
                    nowMarker.setMap(null);
                }

                nowMarker = new kakao.maps.Marker({
                    map: map,
                    position: locPosition,
                    image: new kakao.maps.MarkerImage(personImg, personImgSize, personImgOption)
                });

                nowMarker.setZIndex(2);
                callback(locPosition);

            });
        }
        getLocation();

    } else { // HTML5의 GeoLocation을 사용할 수 없을때
        console.log("GeoLocation 사용불가");
        var locPosition = new kakao.maps.LatLng(37.49962779517117, 127.03048032853766);

        if (nowMarker) {
            nowMarker.setMap(null);
        }

        nowMarker = new kakao.maps.Marker({
            map: map,
            position: locPosition,
            image: new kakao.maps.MarkerImage(personImg, personImgSize, personImgOption)
        });

        nowMarker.setZIndex(2);
        callback(locPosition);
        }
    }

    // 지도 중심으로 이동시키기
    function panTo(moveLatLon) {
        map.panTo(moveLatLon);
    }

    // 미션마커 설정
    function setMissionMarkers(lat,lng){

        var markerImg = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption)
        var markerPosition = new kakao.maps.LatLng(lat, lng);
        var marker = new kakao.maps.Marker({
            position: markerPosition,
            image: markerImg,
            clickable: true
        });

        marker.setMap(map);

        missionMarker.push(marker);
    }

    // 마커 삭제
    function hideMarkers(){

        for (var i = 0; i < missionMarker.length; i++) {
            missionMarker[i].setMap(null);
        }
        // 배열 비우기
        missionMarker = [];
        if (goalMarker) {
            goalMarker.setMap(null);
            goalMarker = null;
        }
    }
    
    // 폴리라인
    function poly(nowLoc, courseLoc) {
        var linePath = [
            new kakao.maps.LatLng(nowLoc.la, nowLoc.ma),
            new kakao.maps.LatLng(courseLoc.la, courseLoc.ma)
        ];

        // 지도에 표시할 선을 생성합니다
        var polyline = new kakao.maps.Polyline({
            path: linePath,
            strokeWeight: 0,
            strokeColor: 'white',
            strokeOpacity: 0,
            strokeStyle: 'solid'
        });

        polyline.setMap(map);
    }


    // 현재위치로 이동하는 버튼
    function findMyLocation(){

        const findMyLocationBtn = document.getElementById('findMyLocation');
        
        // 클릭 시 색상 변경
        findMyLocationBtn.style.backgroundColor = 'rgb(233, 233, 233)';

        // 일정 시간 후에 원래 색상으로 복원 (예: 300ms 후)
        setTimeout(function() {
            findMyLocationBtn.style.backgroundColor = 'white';
        }, 100);

        getNowLocation(function(locPosition) {
            panTo(locPosition);
        });
    }

    function loadMyRecruitingMission(mission_id){

        const myRecruitingMission = document.getElementById("myRecruitingMission");
        myRecruitingMission.classList.remove("d-none");

        const data ={
            mission_id: mission_id
        }

        fetch("./loadResMissionInfoInRecruiting", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(response => {

                console.log(response.data)

                let mission = response.data;

                if(mission.missionCourseList.length > 1){

                    const container = 26.5 - mission.missionCourseList.length * 1.5;

                    const mapContainer = document.getElementById("map");
                    mapContainer.style.height = `${container}rem`;
    
                    getNowLocation(function(locPosition) {
                        map.relayout();
                        map.panTo(locPosition);
                    });
                }

                const missionCourseListBox = document.getElementById("missionCourseListBox");

                const title = document.querySelector("#myRecruitingMission .title");
                const countApp = document.querySelector("#myRecruitingMission .countApp");
                const limitHour = document.querySelector("#myRecruitingMission .limitHour");
                const limitMinute = document.querySelector("#myRecruitingMission .limitMinute");
                const detail = document.getElementById("detail");


                title.innerText = mission.missionInfoDto.title;
                countApp.innerText = (mission.missionChatRoomList).length;
                detail.innerText = mission.missionInfoDto.detail;

                var limitTime = mission.missionInfoDto.limit_time;

                var hour = Math.floor(limitTime / 60);
                var minutes = limitTime % 60;

                if(hour < 10){
                    limitHour.innerText = "0" + hour;
                }else{
                    limitHour.innerText = hour;
                }

                if(minutes < 10){
                    limitMinute.innerText = "0" + minutes;
                }else{
                    limitMinute.innerText = minutes;
                }
                
                for (let i = 0; i < mission.missionCourseList.length; i++) {
                    
                    const course = mission.missionCourseList[i];
                    
                    const basicCourseWrapper = document.querySelector("#progressTemplete .basicCourseWrapper").cloneNode(true);

                    const courseIndex = basicCourseWrapper.querySelector(".courseIndex");
                    const courseName = basicCourseWrapper.querySelector(".courseName");
                    const courseLocation = basicCourseWrapper.querySelector(".courseLocation");
                    const courseReward = basicCourseWrapper.querySelector(".courseReward");

                    courseIndex.innerText = i + 1;
                    courseName.innerText = course.content;
                    courseReward.innerText = course.reward;

                    const lat = course.lat;
                    const lng = course.lng;

                    (function (currentLat, currentLng) {
                        var geocoder = new kakao.maps.services.Geocoder();
                        geocoder.coord2Address(currentLng, currentLat, function (result, status) {
                            if (status === kakao.maps.services.Status.OK) {
                                if (result[0].road_address === null) {
                                    courseLocation.innerText = result[0].address.address_name;
                                } else {
                                    courseLocation.innerText = result[0].road_address.address_name;
                                }

                                var locPosition = new kakao.maps.LatLng(lat, lng);
                                if(i === (mission.missionCourseList.length - 1)){
                                    goalMarker = new kakao.maps.Marker({
                                        map: map,
                                        position: locPosition,
                                        image: new kakao.maps.MarkerImage(goalImg, goalImgSize, goalImgOption)
                                    });
                                    goalMarker.setZIndex(2);
                                }

                                courseName.addEventListener('click', function() {
                                    panTo(locPosition);
                                });

                                courseName.addEventListener('touchstart', function() {
                                    courseIndex.style.backgroundColor = '#ffcf98';
                                });

                                courseName.addEventListener('touchend', function() {
                                    courseIndex.style.backgroundColor = '#FF8827';
                                });

                            } else {
                                console.log('주소를 가져오지 못했습니다.');
                            }
                        });
                    })(lat, lng);

                    if(i < (mission.missionCourseList.length - 1)){
                        setMissionMarkers(lat,lng);
                    }

                    missionCourseListBox.appendChild(basicCourseWrapper);
                    }


            });
    }

    function loadMyResMissionInProgress(chat_room_id){

        const missionInProgress = document.getElementById("missionInProgress");
        missionInProgress.classList.remove("d-none");

        const data ={
            chat_room_id: chat_room_id
        }

        fetch("./loadMyResMissionInProgress", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(response => {

                let mission = response.data;

                console.log(mission);

                if(mission.courseInfoList.length > 1){

                    const container = 26.5 - mission.courseInfoList.length;

                    const mapContainer = document.getElementById("map");
                    mapContainer.style.height = `${container}rem`;
    
                    getNowLocation(function(locPosition) {
                        map.relayout();
                        map.panTo(locPosition);
                    });
                }

                missionCourseListBox.innerHTML = "";

                const title = missionInProgress.querySelector(".title");
                const nowProcess = missionInProgress.querySelector(".nowProcess");
                const limitHour = missionInProgress.querySelector(".limitHour");
                const limitMinute = missionInProgress.querySelector(".limitMinute");
                const detail = document.getElementById("detail");
                const progressbar = document.getElementById("progressbar");
                const countdownElement = document.getElementById("countdownElement");

                detail.innerText = mission.missionInfoDto.detail;

                if(mission.courseInfoList.length == mission.countCompleteCourse){
                    nowProcess.innerText = "미션 진행 완료";
                }else{
                    nowProcess.innerText = ((mission.countCompleteCourse) + 1) + "코스 진행중";
                }

                var countdownStartDate = new Date(mission.missionChatRoomDto.accept_at);
                var limitTimeInMilliseconds = mission.missionInfoDto.limit_time * 60 * 1000;

                var remainingTime = 0;
 
                var timerId = setInterval(function () {
                    // 현재 시간 구하기
                    var currentDate = new Date();
                    
                    // 경과한 시간 계산
                    var overtime = currentDate - countdownStartDate;
                    
                    // 남은 시간 계산
                    remainingTime = limitTimeInMilliseconds - overtime;
                    
                    // 시간이 다 지났으면 타이머 종료
                    if (remainingTime <= 0) {
                        clearInterval(timerId);
                        countdownElement.innerHTML = '미션종료';
                        countdownElement.style.color = "#929292";
                        countdownElement.style.fontSize = "0.9rem";
                    } else {
                        // 남은 시간을 분과 초로 변환
                        var hour = Math.floor(remainingTime / (60 * 60 * 1000));
                        var minutes = Math.ceil((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
                        var remainingSeconds = Math.ceil((remainingTime % (60 * 1000)) / 1000);
        
                        if(hour < 10){
                            limitHour.innerText = "0" + hour;
                        }else{
                            limitHour.innerText = hour;
                        }

                        if(minutes < 10){
                            limitMinute.innerText = "0" + minutes;
                        }else{
                            limitMinute.innerText = minutes;
                        }
                    }
                }, 1000);

                if(sessionUser == mission.missionChatRoomDto.user_id && mission.missionInfoDto.status != "미션종료"){
                    title.innerHTML = `${mission.missionInfoDto.title}
                                        <span class="dropdown">
                                            <button class="btn border-0 bg-white dropdown-toggle px-1 py-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            </button>
                                            <ul class="dropdown-menu shadow-sm py-1">
                                                <li style="font-size:0.8rem; width: 2rem;"><a class="dropdown-item" onclick="giveup()">미션 포기하기</a></li>
                                            </ul>
                                        </span>`;
                }else{
                    title.innerText = mission.missionInfoDto.title;
                }

                if(mission.progressPercent == 0){
                    progressbar.style.width = `5%`
                }else{
                    progressbar.style.width = `${mission.progressPercent}%`
                }

                for (let i = 0; i < mission.courseInfoList.length; i++) {

                    const course = mission.courseInfoList[i];

                    if(mission.countCompleteCourse == i && mission.missionChatRoomDto.user_id == sessionUser && mission.missionInfoDto.status != "미션종료"){

                        const inProgressWrapper = document.querySelector("#progressTemplete .inProgressWrapper").cloneNode(true);
                        const courseIndex = inProgressWrapper.querySelector(".courseIndex");
                        const courseName = inProgressWrapper.querySelector(".courseName");
                        const courseLocation = inProgressWrapper.querySelector(".courseLocation");
                        const courseReward = inProgressWrapper.querySelector(".courseReward");
                        const successBtn = inProgressWrapper.querySelector(".successBtn");
    
                        courseIndex.innerText = i + 1;
                        courseName.innerText = course.missionCourseDto.content;
                        courseReward.innerText = course.missionCourseDto.reward;
    
                        const lat = course.missionCourseDto.lat;
                        const lng = course.missionCourseDto.lng;

                        navigator.geolocation.getCurrentPosition(function (position) {
                            var nowlat = position.coords.latitude; // 위도
                            var nowlon = position.coords.longitude; // 경도

                            var linePath = [
                                new kakao.maps.LatLng(lat, lng),
                                new kakao.maps.LatLng(nowlat, nowlon)
                            ];

                            // 지도에 표시할 선을 생성합니다
                            var polyline = new kakao.maps.Polyline({
                                path: linePath,
                                strokeWeight: 0,
                                strokeColor: 'red',
                                strokeOpacity: 0,
                                strokeStyle: 'solid'
                            });

                            polyline.setMap(map);
                            const distance = polyline.getLength();

                            successBtn.onclick = function () {
                                if(distance <= 100){
                                    openMissionComplModal(locPosition);
                                }else{
                                    alert("코스 목표지점의 100m내 거리에서만 미션 완료인증이 가능합니다.");
                                }
                            };

                        });
///////////
                        (function (currentLat, currentLng) {
                            var geocoder = new kakao.maps.services.Geocoder();
                            geocoder.coord2Address(currentLng, currentLat, function (result, status) {
                                if (status === kakao.maps.services.Status.OK) {
                                    if (result[0].road_address === null) {
                                        courseLocation.innerText = result[0].address.address_name;
                                    } else {
                                        courseLocation.innerText = result[0].road_address.address_name;
                                    }
    
                                    var locPosition = new kakao.maps.LatLng(lat, lng);
                                    if(i === (mission.courseInfoList.length - 1)){
                                        goalMarker = new kakao.maps.Marker({
                                            map: map,
                                            position: locPosition,
                                            image: new kakao.maps.MarkerImage(goalImg, goalImgSize, goalImgOption)
                                        });
                                        goalMarker.setZIndex(2);
                                    }
    
                                    courseName.addEventListener('click', function() {
                                        panTo(locPosition);
                                    });
                                    courseName.addEventListener('touchstart', function() {
                                        courseIndex.style.backgroundColor = '#ffcf98';
                                    });
                                    courseName.addEventListener('touchend', function() {
                                        courseIndex.style.backgroundColor = '#FF8827';
                                    });
    
                                } else {
                                    console.log('주소를 가져오지 못했습니다.');
                                }
                            });
                        })(lat, lng);
    
                        if(i < (mission.courseInfoList.length - 1)){
                            setMissionMarkers(lat,lng);
                        }
    
                        missionCourseListBox.appendChild(inProgressWrapper);

                    }else if((mission.countCompleteCourse <= i && mission.missionChatRoomDto.user_id != sessionUser) || (mission.countCompleteCourse < i && mission.missionChatRoomDto.user_id == sessionUser && mission.missionInfoDto.status != "미션종료") ){
                        const notInProgressWrapper = document.querySelector("#progressTemplete .notInProgressWrapper").cloneNode(true);
    
                        const courseIndex = notInProgressWrapper.querySelector(".courseIndex");
                        const courseName = notInProgressWrapper.querySelector(".courseName");
                        const courseLocation = notInProgressWrapper.querySelector(".courseLocation");
                        const courseReward = notInProgressWrapper.querySelector(".courseReward");

                        if(mission.countCompleteCourse == i && mission.missionChatRoomDto.user_id != sessionUser){
                            courseIndex.style.backgroundColor = "#FF8827";
                            courseIndex.style.boxShadow = "0 0 0 0.15em #ffcf98";

                            courseName.classList.add("text-dark-emphasis");
                            courseLocation.classList.add("text-body-tertiary");
                            courseReward.style.color="#b1b1b1";

                            courseName.addEventListener('touchstart', function() {
                                courseIndex.style.backgroundColor = '#ffcf98';
                            });
                            courseName.addEventListener('touchend', function() {
                                courseIndex.style.backgroundColor = '#FF8827';
                            });

                        }else{
                            courseName.addEventListener('touchstart', function() {
                                courseIndex.style.backgroundColor = '#ffcf98';
                            });
                            courseName.addEventListener('touchend', function() {
                                courseIndex.style.backgroundColor = '#dfdfdf';
                            });
                        }

                        courseIndex.innerText = i + 1;
                        courseName.innerText = course.missionCourseDto.content;
                        courseReward.innerText = course.missionCourseDto.reward;
    
                        const lat = course.missionCourseDto.lat;
                        const lng = course.missionCourseDto.lng;
    
                        (function (currentLat, currentLng) {
                            var geocoder = new kakao.maps.services.Geocoder();
                            geocoder.coord2Address(currentLng, currentLat, function (result, status) {
                                if (status === kakao.maps.services.Status.OK) {
                                    if (result[0].road_address === null) {
                                        courseLocation.innerText = result[0].address.address_name;
                                    } else {
                                        courseLocation.innerText = result[0].road_address.address_name;
                                    }
    
                                    var locPosition = new kakao.maps.LatLng(lat, lng);
                                    if(i === (mission.courseInfoList.length - 1)){
                                        goalMarker = new kakao.maps.Marker({
                                            map: map,
                                            position: locPosition,
                                            image: new kakao.maps.MarkerImage(goalImg, goalImgSize, goalImgOption)
                                        });
                                        goalMarker.setZIndex(2);
                                    }
    
                                    courseName.addEventListener('click', function() {
                                        panTo(locPosition);
                                    });
    
                                } else {
                                    console.log('주소를 가져오지 못했습니다.');
                                }
                            });
                        })(lat, lng);
    
                        if(i < (mission.courseInfoList.length - 1)){
                            setMissionMarkers(lat,lng);
                        }
    
                        missionCourseListBox.appendChild(notInProgressWrapper);

                    }else if(mission.countCompleteCourse > i){

                        const completeWrapper = document.querySelector("#progressTemplete .completeWrapper").cloneNode(true);
                        const courseIndex = completeWrapper.querySelector(".courseIndex");
                        const courseName = completeWrapper.querySelector(".courseName");
                        const courseLocation = completeWrapper.querySelector(".courseLocation");
                        const courseReward = completeWrapper.querySelector(".courseReward");
                        const checkCompleteBtn = completeWrapper.querySelector(".checkCompleteBtn");

                        (function (checkCompleteBtn, courseComplete) {
                            checkCompleteBtn.onclick = function () {
                                openMissionConfirmModal(courseComplete);
                            };
                        })(checkCompleteBtn, course.missionProcessDto);
    
                        courseIndex.innerText = i + 1;
                        courseName.innerText = course.missionCourseDto.content;
                        courseReward.innerText = course.missionCourseDto.reward;
    
                        const lat = course.missionCourseDto.lat;
                        const lng = course.missionCourseDto.lng;
    
                        (function (currentLat, currentLng) {
                            var geocoder = new kakao.maps.services.Geocoder();
                            geocoder.coord2Address(currentLng, currentLat, function (result, status) {
                                if (status === kakao.maps.services.Status.OK) {
                                    if (result[0].road_address === null) {
                                        courseLocation.innerText = result[0].address.address_name;
                                    } else {
                                        courseLocation.innerText = result[0].road_address.address_name;
                                    }
    
                                    var locPosition = new kakao.maps.LatLng(lat, lng);
                                    if(i === (mission.courseInfoList.length - 1)){
                                        goalMarker = new kakao.maps.Marker({
                                            map: map,
                                            position: locPosition,
                                            image: new kakao.maps.MarkerImage(goalImg, goalImgSize, goalImgOption)
                                        });
                                        goalMarker.setZIndex(2);
                                    }
    
                                    courseName.addEventListener('click', function() {
                                        panTo(locPosition);
                                    });
                                    courseName.addEventListener('touchstart', function() {
                                        courseIndex.style.backgroundColor = '#ffcf98';
                                    });
                                    courseName.addEventListener('touchend', function() {
                                        courseIndex.style.backgroundColor = '#dfdfdf';
                                    });
    
                                } else {
                                    console.log('주소를 가져오지 못했습니다.');
                                }
                            });
                        })(lat, lng);
    
                        if(i < (mission.courseInfoList.length - 1)){
                            setMissionMarkers(lat,lng);
                        }
    
                        missionCourseListBox.appendChild(completeWrapper);
                        }
                    }

                if(mission.progressPercent == 100){

                    if(mission.missionInfoDto.user_id == sessionUser){
                        const reviewBtn = document.getElementById("reviewBtn");
                        reviewBtn.classList.remove("d-none");
                    }else{
                        const viewReviewBtn = document.getElementById("viewReviewBtn");
                        viewReviewBtn.classList.remove("d-none");
                    }

                    clearInterval(timerId);
                    countdownElement.innerHTML = '미션종료';
                    countdownElement.style.color = "#929292";
                    countdownElement.style.fontSize = "0.9rem";
                }  
                    
            });
    }

    // 상세보기 버튼
    function loadShowMore(){

        const detailBox = document.getElementById("detailBox");

        const showMore = document.getElementById("showMore");
        
        if(detailBox.classList.contains("d-none")){
            detailBox.classList.remove("d-none");
            showMore.querySelector(".btn").innerHTML = `<i class="bi bi-chevron-compact-up fs-5" style="color: #b1b1b1;"></i>`;
        }else{
            detailBox.classList.add("d-none");
            showMore.querySelector(".btn").innerHTML = `<i class="bi bi-chevron-compact-down fs-5" style="color: #b1b1b1;"></i>`;
        }
    }

    // 미션완료 인증 모달
    function openMissionComplModal(course){

        const modal = bootstrap.Modal.getOrCreateInstance("#missionComplModal");
        const missionComplModal = document.getElementById("missionComplModal");
        const submitMissionComplBtn = document.getElementById("submitMissionComplBtn");

        submitMissionComplBtn.onclick = function(){
            submitMissionComplete(course);
        }
        modal.show();
    }

    // 미션완료 인증 모달 닫기
    function closeMissionComplModal() {
    	const modal = bootstrap.Modal.getOrCreateInstance("#missionComplModal");
        modal.hide();
	}

    // 미션 완료 인증 서브밋
    function submitMissionComplete(course){
        
        const complete_img = document.getElementById('complete_img');
        const complete_comment = document.getElementById('complete_comment');
        const file = complete_img.files[0];

        var formData = new FormData();
        formData.append('complete_img', file);
        formData.append('complete_comment', complete_comment.value);
        formData.append('mission_course_id', course.missionCourseDto.mission_course_id);
        formData.append('chat_room_id', chat_room_id);

        fetch("./submitMissionComplete", {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(response => {
                complete_comment.value = "";
                complete_img.value = "";
                closeMissionComplModal();
                loadMyResMissionInProgress(chat_room_id);
        });
    }

    // 미션완료 인증확인 모달
    // 미션완료 인증 모달
    function openMissionConfirmModal(complete){

        const modal = bootstrap.Modal.getOrCreateInstance("#missionConfirmModal");
        const missionConfirmModal = document.getElementById("missionConfirmModal");

        // 이미지와 텍스트 출력
        const complete_img = document.querySelector("#missionConfirmModal .complete_img");
        const complete_comment = document.querySelector("#missionConfirmModal .complete_comment");

        complete_img.setAttribute("src", `/uploadFiles/ufuf/chatImg${complete.complete_img}`);
        complete_comment.innerText = complete.complete_comment;

        modal.show();
    }

    // 미션완료 인증 모달 닫기
    function closeMissionConfirmModal() {
    	const modal = bootstrap.Modal.getOrCreateInstance("#missionConfirmModal");
        modal.hide();
	}

    // 미션 포기
    function giveup() {

        const inputMessage = document.getElementById("inputMessage");

        const data = {
            chat_room_id: chat_room_id,
        }

        fetch("./giveup", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(response => {
                loadMyResMissionInProgress(chat_room_id);
            });
    }


    // 이미지 파일 선택하면 바로 프론트에서 호출
    function showSelectedImg(input) {

        if (input.files && input.files[0]) {

            var reader = new FileReader();

            reader.onload = function(e) {
            document.getElementById('loadImg').src = e.target.result;
            };

            reader.readAsDataURL(input.files[0]);

        } else {
            document.getElementById('loadImg').src = "";
        }
    }

    window.addEventListener("DOMContentLoaded", () => {

        if(mission_id != null){
            loadMyRecruitingMission(mission_id);
        }else{
            loadMyResMissionInProgress(chat_room_id);
        }

    });

</script>

<style>

    *{font-family: -apple-system, 
        BlinkMacSystemFont, 
        "Apple SD Gothic Neo", 
        "Pretendard Variable", 
        Pretendard, Roboto, 
        "Noto Sans KR", 
        "Segoe UI",
        "Malgun Gothic", 
        "Apple Color Emoji", 
        "Segoe UI Emoji", 
        "Segoe UI Symbol", 
        sans-serif;
        letter-spacing: 0.03em;
    }

    .form-control:focus {
      border-color: #ffbf8b; /* 클릭 시 테두리 색상 변경 */
      box-shadow: 0 0 0 0.1em #ffe2ce; /* 기본 제공되는 박스 쉐도우를 제거합니다. */
    }

    body { 
        position: fixed;
        width: 100%;
    }

    .word {
        width: 1rem;
        font-size: 1rem;
        font-weight: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #map{
        z-index: 1;
        position: fixed;
        bottom: 3.45rem;
    }

    #info {
        z-index: 3;
        position: fixed;
        top: 0rem;
        margin: 0 auto;
        left: 0;
        right: 0;
    }

    #missionComplModal{
        width: 95%;
        top: 7%;
        left: 2.5%;
    }

    #findMyLocation{
        z-index: 2;
        position: fixed;
        bottom: 4.1rem;
        /* margin: auto;
        left: 0; */
        right: 0.6em;
        box-shadow: 0.08em 0.14em 0.28em 0.0em rgba(119, 119, 119, 0.3);
        transition: top 0.8s ease;
    }


</style>

</head>

<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col px-0">

                <div  id="info" class="row px-2 bg-white border-bottom">
                    <div class="col">
                        <div class="row mt-3">
                            <div class="col">
                                <i class="bi bi-x-lg fw-semibold text-body-tertiary" onclick="window.history.back();"></i>
                            </div>
                        </div>
        
                        <div id="scrollContainer" class="row pb-1 mt-1 z-3 overflow-x-hidden" style="height:auto; max-height: 30rem; margin-top: 0.2rem; overflow-y: hidden; ">
                            <div class="col">
                                <div id="myRecruitingMission" class="row d-none">
                                    <div class="col align-self-center">
                                        <div class="row">
                                            <div class="title col align-self-center fw-bold pe-1" style="font-size: 1.05rem;">
                                                나랑 같이 밥먹고 데이트할 은비
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-7 px-0 align-self-center border-bottom" style="font-size: 0.8rem; color:#757575; width: fit-content; margin-left: 0.72rem;">
                                                <span class="pe-1 align-middle">미션신청자</span>
                                                <span class="countApp align-middle"></span>
                                                <i class="bi bi-chevron-double-right align-self-center" style="font-size: 0.6rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3 rounded-2 pe-1 align-self-center">
                                        <div class="row">
                                            <div class="col text-center" style="font-size: 0.77rem; color:#757575;">
                                                제한 시간
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col d-flex justify-content-center fw-bold" style="font-size: 1.05rem;">
                                                <span class="limitHour" style="color:#FF8827;"></span>
                                                <span class="mx-1" style="color:#b3b3b3;">:</span>
                                                <span class="limitMinute" style="color:#FF8827;"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
        
                                <div id="missionInProgress" class="row d-none">
                                    <div class="col">
                                        <div class="row">
                                            <div class="col align-self-center">
                                                <div class="row">
                                                    <div class="title col fw-bold pe-0" style="font-size: 1.05rem;">
                                                        
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="nowProcess col" style="font-size: 0.85rem; color:#757575;">
                                                        
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-3 rounded-2 pe-1 align-self-center">
                                                <div class="row">
                                                    <div class="col text-center" style="font-size: 0.77rem; color:#757575;">
                                                        제한 시간
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div id="countdownElement" class="col d-flex justify-content-center fw-bold" style="font-size: 1.03rem;">
                                                        <span class="limitHour" style="color:#FF8827;"></span>
                                                        <span class="mx-1" style="color:#b3b3b3;">:</span>
                                                        <span class="limitMinute" style="color:#FF8827;"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col">
                                                <div class="progress" role="progressbar" style="background-color: #eeeeee; height: 0.8rem;">
                                                    <div id="progressbar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 20%; background-color: #FF8827;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-2 mb-2">
                                    <div id="missionCourseListBox" class="col mt-1">
                                        
                                    </div>
                                </div>

                                <div id="reviewBtn" class="row d-none">
                                    <div class="col d-grid mb-1">
                                        <button id="writeReview" type="button" class="btn py-1 fw-semibold rounded-1" 
                                            style="border: 0.1em solid #b1b1b1; color:#666666; background-color: white; font-size: 0.9rem;">
                                            <span class="px-1">미션 리뷰 작성</span>
                                        </button>
                                    </div>
                                </div>

                                <div id="viewReviewBtn" class="row d-none">
                                    <div class="col d-grid mb-1">
                                        <button id="viewReview" type="button" class="btn py-1 fw-semibold rounded-1" 
                                            style="border: 0.1em solid #b1b1b1; color:#666666; background-color: white; font-size: 0.9rem;">
                                            <span class="px-1">미션 리뷰 확인</span>
                                        </button>
                                    </div>
                                </div>

                                <div id="detailBox" class="row mt-2 d-none">
                                    <div class="col px-3 mt-1">
                                        <div class="row">
                                            <div class="col-3 fw-semibold text-body" style="font-size: 0.87em;">
                                                미션상세
                                            </div>
                                            <div class="col border-bottom mb-2 me-2"></div>
                                        </div>
                                        <div class="row mt-1 mb-1">
                                            <div class="col">
                                                <span id="detail" class="text-secondary align-self-center" style="font-size: 0.8em;">
        
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
        
                                <div id="showMore" class="row" onclick="loadShowMore()">
                                    <div class="btn col text-center py-0 border-0" style="height: 1.6rem;">
                                        <i class="bi bi-chevron-compact-down fs-5" style="color: #b1b1b1;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 지도 -->
                <div class="row" style="margin-left: 0.05rem; margin-right: 0.05rem;">
                    <div class="col px-0">
                        <div id="map" style="height: 26.5rem; width: 100%;">
                            <script>

                                var mapContainer = document.getElementById("map"), // 지도를 표시할 div
                                    mapOption = { 
                                        center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                                        level: 3 // 지도의 확대 레벨
                                    };

                                var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

                                map.setZoomable(true);
                                map.setMinLevel(1);
                                map.setMaxLevel(5);

                                function updateNowLocation() {

                                    getNowLocation(function(locPosition) {
                                        panTo(locPosition);
                                    });

                                    setInterval(function() {

                                        getNowLocation(function(locPosition) {

                                            const mapCenter = map.getCenter();

                                            // 좌표 비교를 위한 오차 범위
                                            const tolerance = 0.00015;

                                            const isSameLocation = Math.abs(mapCenter.getLat() - locPosition.getLat()) < tolerance && 
                                                                    Math.abs(mapCenter.getLng() - locPosition.getLng()) < tolerance;

                                            if(isSameLocation){
                                                panTo(locPosition);
                                            }else{

                                            }

                                        });
                                    }, 10000);

                                }

                                updateNowLocation();

                            </script>
                        </div>
                    </div>
                </div>


            </div>
        </div>
        <th:block th:replace="~{commons/missionFragmentPage.html :: footer}"></th:block>
    </div>




<div class="row" >
    <div class="col-2 px-0">
        <button id="findMyLocation" class="btn-sm text-secondary border px-0 fs-5 text-center" 
            onclick="findMyLocation()" style="height: 2.2rem; width: 2.2rem; border-radius: 50%; background-color: white;">
            <i class="bi bi-crosshair d-flex justify-content-center text-center align-self-center"></i>
        </button>
    </div>
</div>

<div id="progressTemplete" class="d-none">
    <div class="basicCourseWrapper row py-1">
        <div class="col-2 d-flex justify-content-center align-items-center" style="width: fit-content;">
            <span class="courseIndex rounded-circle text-center border border-white d-flex justify-content-center align-items-center"  
                style="background-color: #FF8827; color: white; width: 1.3em; height: 1.3em;">
                1
            </span>
        </div>
        <div class="col ps-0 pe-3 align-self-center">
            <div class="row">
                <div class="courseName col fw-semibold pe-1 text-dark-emphasis" style="font-size: 0.9em;">
                    
                </div>
            </div>
            <div class="row">
                <div class="courseLocation col pe-1 align-self-center text-body-tertiary" style="font-size: 0.75em;">
                    
                </div>
            </div>
        </div>
        <div class="col-3 text-end align-self-center ps-1">
            <span class="courseReward align-self-center fw-semibold" style="color: #b1b1b1; font-size: 0.87em;">1000</span>
            <span class="align-self-center text-secondary" style="font-size: 0.78em;">원</span>
        </div>
    </div>

    <div class="notInProgressWrapper row py-1">
        <div class="col-2 d-flex justify-content-center align-items-center" style="width: fit-content;">
            <span class="courseIndex rounded-circle text-center border border-white d-flex justify-content-center align-items-center"  
                style="background-color: #dfdfdf; color: white; width: 1.4em; height: 1.4em;">
                1
            </span>
        </div>
        <div class="col px-0 align-self-center">
            <div class="row">
                <div class="courseName col fw-semibold pe-1" style="font-size: 0.9em; color: #b4b4b4;">
                    
                </div>
            </div>
            <div class="row">
                <div class="courseLocation col pe-1" style="font-size: 0.7em; color: #dbdbdb;">
                    
                </div>
            </div>
        </div>
        <div class="col-3 text-end align-self-center ps-1">
            <span class="courseReward align-self-center fw-semibold" style="color: #d8d8d8; font-size: 0.87em;">1000</span>
            <span class="align-self-center" style="color: #d8d8d8; font-size: 0.78em;">원</span>
        </div>
    </div>

    <div class="inProgressWrapper row py-1">
        <div class="col-2 d-flex justify-content-center align-items-center" style="width: fit-content;">
            <span class="courseIndex rounded-circle text-center border border-white d-flex justify-content-center align-items-center"  
                style="background-color: #FF8827; color: white; width: 1.3em; height: 1.3em; box-shadow: 0 0 0 0.15em #ffcf98;">
                2
            </span>
        </div>
        <div class="col px-0 align-self-center">
            <div class="row align-self-center">
                <div class="courseName col fw-semibold text-dark-emphasis pe-1 align-self-center" style="font-size: 0.9em;">
                    
                </div>
            </div>
            <div class="row align-self-center">
                <div class="courseLocation col text-body-tertiary pe-1 align-self-center" style="font-size: 0.7em;">
                    
                </div>
            </div>
        </div>
        <div class="col-3 d-flex justify-content-end align-self-center ps-1">
            <button type="button" class="successBtn btn fw-semibold rounded-1 py-0 border-0" 
                style="background-color: #FF8827; font-size: 0.78rem; padding-left: 0.4rem; padding-right: 0.4rem;">
                <span class="text-white text-center">완료인증</span><br>
                <span class="text-center">
                    <span class="courseReward align-self-center fw-semibold" style="font-size: 0.75rem; color: #fffbee;"></span>
                    <span class="align-self-center" style="font-size: 0.7rem; color: #fff1cc;">원</span>
                </span>
            </button>
        </div>
    </div>

    <div class="completeWrapper row py-1">
        <div class="col-2 d-flex justify-content-center align-items-center" style="width: fit-content;">
            <span class="courseIndex rounded-circle text-center border border-white d-flex justify-content-center align-items-center"  
                style="background-color: #dfdfdf; color: white; width: 1.4em; height: 1.4em;">
                1
            </span>
        </div>
        <div class="col px-0 align-self-center">
            <div class="row">
                <div class="courseName col fw-semibold pe-1" style="font-size: 0.9em; color: #b4b4b4;">
                </div>
                <div class="col-3 d-flex justify-content-end align-self-center ps-1" style="padding-right: 1.41rem;">
                    <button type="button" class="checkCompleteBtn btn rounded-1 py-0" 
                        style="border: 0.05rem solid #c0c0c0; color: #a0a0a0; font-size: 0.75rem; padding-left: 0.38rem; padding-right: 0.38rem;">
                        <span class="text-center">인증확인</span>
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="courseLocation col pe-1 align-self-top" style="font-size: 0.7em; color: #dbdbdb;">
                </div>
                <div class="col-3 text-end align-self-top ps-0" style="padding-right: 1.41rem;">
                    <span class="courseReward align-top fw-semibold" style="color: #d8d8d8; font-size: 0.8rem;">1000</span>
                    <span class="align-top" style="color: #d8d8d8; font-size: 0.75rem;">원</span>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 미션 완료 작성 모달 -->
<div id="missionComplModal" class="modal mx-auto">
    <div class="modal-dialog shadow">
        <div class="modal-content rounded-2">
            <div class="modal-body px-3 pt-2">
                <div class="row mt-3">
                    <div class="col mt-1">
                        <div class="row">
                            <div class="col fw-semibold text-secondary">
                                미션코스 완료인증 사진
                            </div>
                        </div>
                        <div class="row mt-1 px-1">
                            <div class="col border d-flex justify-content-center mx-2 py-5">
                                <label for="complete_img">
                                    <img class="img-fluid" id="loadImg" th:src="@{/public/image/commons/img_need_upload.png}" style="height: 4.5em;">
                                </label>
                                <input class="form-control border-dark-subtle" type="file" name="complete_img" id="complete_img" accept="image/*" style="display:none;" onchange="showSelectedImg(this);">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col fw-semibold text-secondary">
                                미션코스 완료 코멘트
                            </div>
                        </div>
                        <div class="row mt-1">
                            <div class="col">
                                <textarea class="form-control rounded-0" id="complete_comment" placeholder="코멘트를 입력해주세요" style="height: 7em; font-size:0.9em;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 mb-2 d-grid">
                <div class="gap-2 d-md-block">
                    <button class="btn px-3 rounded-1 me-1 py-1" type="button" style="border: 0.1em solid #e9ba95; color:#FF8827;" onclick="closeMissionComplModal()">
                        취소
                    </button>
                    <button id="submitMissionComplBtn" class="btn text-white px-3 rounded-1 py-1" type="button" style="background-color: #FF8827;">완료 인증</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 미션 완료 인증 확인 모달 -->
<div id="missionConfirmModal" class="modal mx-auto">
    <div class="modal-dialog shadow">
        <div class="modal-content rounded-2">
            <div class="modal-body px-3 pt-2">
                <div class="row mt-3">
                    <div class="col mt-1">
                        <div class="row">
                            <div class="col fw-semibold text-secondary">
                                미션코스 완료인증 사진
                            </div>
                        </div>
                        <div class="row mt-1 px-1">
                            <div class="col border d-flex justify-content-center mx-2 py-5">
                                <img class="img-fluid complete_img" style="height: 4.5em;">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col fw-semibold text-secondary">
                                미션코스 완료 코멘트
                            </div>
                        </div>
                        <div class="row mt-1">
                            <div class="col complete_comment" style="font-size: 0.9rem;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 mb-2 d-grid">
                <button class="btn text-white px-3 rounded-1 py-1" type="button" style="background-color: #FF8827;" onclick="closeMissionConfirmModal()">닫기</button>
            </div>
        </div>
    </div>
</div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>

</html>