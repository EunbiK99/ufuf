<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cu.ufuf.mission.mapper.MissionMapSqlMapper">

<!-- 미션 등록 -->
<insert id="insertMission">
    <selectKey keyProperty="mission_id" resultType="int" order="AFTER">
        SELECT LAST_INSERT_ID() AS mission_id
    </selectKey>

    INSERT INTO mission_info (
        user_id, 
        title, 
        detail, 
        status, 
        limit_time
        )
    VALUES(
        #{user_id}, 
        #{title}, 
        #{detail}, 
        #{status}, 
        #{limit_time}
    )
</insert>

<insert id="insertMissionCourse">
    INSERT INTO mission_course(
        mission_id,
        content,
        reward,
        lat,
        lng
        )
    VALUES(
        #{mission_id},
        #{content},
        #{reward},
        #{lat},
        #{lng}
    )
</insert>

<select id="selectMissionById" resultType="com.cu.ufuf.dto.MissionInfoDto">
    SELECT * FROM mission_info
    where mission_id = ${mission_id}
</select>

<select id="selectMissionByOrderId" resultType="com.cu.ufuf.dto.MissionInfoDto">
    select mi.* from order_info oi 
    inner join item_info ii on oi.item_id = ii.item_id
    inner join mission_info mi on ii.merchan_id = mi.mission_id
    where oi.order_id = #{order_id}
</select>

<select id="selectAllMission" resultType="com.cu.ufuf.dto.MissionInfoDto">
    select * from mission_info
    WHERE status = '모집중'
</select>

<select id="selectCourseByMission" resultType="com.cu.ufuf.dto.MissionCourseDto">
    select * from mission_course
    where mission_id = #{mission_id}
</select>

<update id="updateStatus">
    update mission_info
    set status = #{param2}
    where mission_id = #{param1}
</update>

<select id="selectUserById" resultType="com.cu.ufuf.dto.UserInfoDto">
    select * from user_info
    where user_id = #{user_id}
</select>

<select id="isUserApplied" resultType="int">
    select count(*) from mission_chat_room
    where mission_id = #{mission_id} 
    and user_id = #{user_id}
</select>

<select id="selectMyResMission" resultType="com.cu.ufuf.dto.MissionInfoDto">
    select * from mission_info
    where user_id = #{user_id}
</select>

<update id="updateAccStatus">
    update mission_chat_room
    set accept_at = now()
    where chat_room_id = #{chat_room_id}
</update>

<insert id="insertMissionProcess">
    <selectKey keyProperty="mission_complete_id" resultType="int" order="AFTER">
        SELECT LAST_INSERT_ID() AS mission_complete_id
    </selectKey>
    insert into mission_process(
        mission_course_id,
        chat_room_id,
        complete_comment,
        complete_img
        )
    VALUES(
        #{mission_course_id},
        #{chat_room_id},
        #{complete_comment},
        #{complete_img}
    )
</insert>

<select id="selectMissionProcessByChatRoomId" resultType="com.cu.ufuf.dto.MissionProcessDto">
    select * from mission_process
    where mission_course_id = #{mission_course_id}
</select>

<select id="countCompleteCourse" resultType="int">
    select count(*) from mission_process
    where chat_room_id = #{chat_room_id}
</select>

<select id="selectMyPlayMission" resultType="com.cu.ufuf.dto.MissionChatRoomDto">
    SELECT *
    FROM mission_chat_room
    WHERE user_id = 5 AND accept_at IS NOT NULL
    order by accept_at desc
</select>

<select id="countProgressPercent" resultType="int">
    SELECT 
    (COUNT(*) / (SELECT COUNT(*) FROM mission_course WHERE mission_id = #{mission_id})) * 100 AS percentage
    FROM mission_process
    WHERE 
    mission_course_id IN (SELECT mission_course_id FROM mission_course WHERE mission_id = #{mission_id})
</select>

<update id="updateGiveup">
    update mission_chat_room
    set giveup_at = now()
    where chat_room_id = #{chat_room_id}
</update>

<select id="countTotalCourseByChatRoomId" resultType="int">
    select COUNT(*) from mission_chat_room mcr 
    inner join mission_course mc on mcr.mission_id = mc.mission_id
    where mcr.chat_room_id = #{chat_room_id}
</select>

















</mapper>